#!/bin/bash
# bin/release - Automated release script

set -e

# Get version from argument or prompt
VERSION=${1:-}
if [ -z "$VERSION" ]; then
    read -p "Enter version (e.g., 1.0.0): " VERSION
fi

echo "Building SSH Config Manager v$VERSION..."

# Update version in config file
sed -i '' "s/'version' => env('NATIVEPHP_APP_VERSION', '.*'),/'version' => env('NATIVEPHP_APP_VERSION', '$VERSION'),/" config/nativephp.php

# Build macOS app
php artisan native:build mac

# Find the built dmg files in the correct directory
DMG_DIR="nativephp/electron/dist"
DMG_FILES=$(find "$DMG_DIR" -name "*.dmg" 2>/dev/null)

if [ -z "$DMG_FILES" ]; then
    echo "Error: No .dmg files found in $DMG_DIR/"
    exit 1
fi

echo "Built DMG files:"
echo "$DMG_FILES"

# Commit version change
git add config/nativephp.php
git commit -m "Bump version to v$VERSION" || echo "No changes to commit"
git push origin main

# Create and push git tag
git tag -a "v$VERSION" -m "Release v$VERSION"
git push origin "v$VERSION"

# Create GitHub release with all dmg files attached
gh release create "v$VERSION" \
    --title "SSH Config Manager v$VERSION" \
    --notes "## Downloads

- **macOS Apple Silicon (M1/M2/M3)**: Download \`Laravel-$VERSION-arm64.dmg\`
- **macOS Intel**: Download \`Laravel-$VERSION-x64.dmg\`

### Installation
1. Download the appropriate .dmg file for your Mac
2. Open the downloaded file
3. Drag SSH Config Manager to your Applications folder" \
    $DMG_DIR/*.dmg

echo "Released v$VERSION to GitHub!"
echo "View at: $(gh repo view --json url -q .url)/releases/tag/v$VERSION"

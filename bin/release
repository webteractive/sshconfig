#!/bin/bash
# bin/release - Automated release script

set -e

# Get version from argument or prompt
VERSION=${1:-}
if [ -z "$VERSION" ]; then
    read -p "Enter version (e.g., 1.0.0): " VERSION
fi

echo "Building SSH Config Manager v$VERSION..."

# Update version in config file
sed -i '' "s/'version' => env('NATIVEPHP_APP_VERSION', '.*'),/'version' => env('NATIVEPHP_APP_VERSION', '$VERSION'),/" config/nativephp.php

# Build macOS app
php artisan native:build mac

# Find the built dmg files in the correct directory
DMG_DIR="nativephp/electron/dist"
DMG_FILES=$(find "$DMG_DIR" -name "*.dmg" 2>/dev/null)

if [ -z "$DMG_FILES" ]; then
    echo "Error: No .dmg files found in $DMG_DIR/"
    exit 1
fi

echo "Built DMG files:"
echo "$DMG_FILES"

# Commit version change
git add config/nativephp.php
git commit -m "Bump version to v$VERSION" || echo "No changes to commit"
git push origin main

# Create and push git tag
git tag -a "v$VERSION" -m "Release v$VERSION"
git push origin "v$VERSION"

# Create GitHub release with all dmg files attached
gh release create "v$VERSION" \
    --title "SSH Config Manager v$VERSION" \
    --notes "## Downloads

### Which file should I download?

- **macOS Apple Silicon (M1/M2/M3)**: Download \`SSHConfig-$VERSION-arm64.dmg\`
- **macOS Intel**: Download \`SSHConfig-$VERSION-x64.dmg\`

**Not sure which one?** Check your Mac's processor:
- Apple menu → About This Mac → Chip: If it says \"Apple\" or \"M1/M2/M3\", download the **arm64** version
- If it says \"Intel\", download the **x64** version

### Installation Instructions

1. **Download** the appropriate .dmg file for your Mac architecture
2. **Open** the downloaded .dmg file (double-click it)
3. **Drag** SSH Config Manager to your Applications folder
4. **Launch** the app from Applications
5. **Set SSH Config Path** when prompted (typically \`~/.ssh/config\`)

### macOS Gatekeeper Security

Since this app is not code-signed with an Apple Developer certificate, macOS Gatekeeper may prevent it from opening. If you see a message saying the app \"cannot be opened because it is from an unidentified developer,\" here are the solutions:

**Solution 1: Right-Click and Open (Recommended)**
1. Right-click (or Control-click) on SSH Config Manager in Applications
2. Select **Open** from the context menu
3. Click **Open** in the security dialog
4. The app will now launch and be added to your security exceptions

**Solution 2: System Settings**
1. Go to **System Settings** → **Privacy & Security**
2. Scroll down to find the message about SSH Config Manager being blocked
3. Click **Open Anyway**
4. Confirm by clicking **Open** in the dialog

**Solution 3: Remove Quarantine Attribute (Advanced)**
If the above methods don't work, you can remove the quarantine attribute via Terminal:
\`\`\`bash
xattr -d com.apple.quarantine /Applications/SSH\\ Config\\ Manager.app
\`\`\`

**Note**: This app is open-source and safe to use. The security warning appears because it's not signed with an Apple Developer certificate (which requires a paid Apple Developer account). You can review the source code on GitHub to verify its safety.

### First Launch

On first launch, you'll be prompted to set the path to your SSH config file. This is required for the application to sync configurations.

**Default path**: \`~/.ssh/config\`

### System Requirements

- macOS 10.12 or later
- SSH config file access

### Features

- Visual SSH Config Management
- Bidirectional Sync
- Conflict Detection
- Quick Copy SSH Commands
- Duplicate Configurations
- Automatic Backups" \
    $DMG_DIR/*.dmg

echo "Released v$VERSION to GitHub!"
echo "View at: $(gh repo view --json url -q .url)/releases/tag/v$VERSION"
